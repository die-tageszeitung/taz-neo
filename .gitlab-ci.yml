image: registry.gitlab.alt.coop/ctrlaltcoop/android-docker:latest

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - sudo chown -R circleci:circleci .

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - app/build
    - build
  key: android-base

stages:
  - test
  - build
  - publish

.extractSecrets:
  stage: build
  before_script:
    - echo $SECRET_BUNDLE_BASE64 | base64 -d > bundle.tar
    - sudo tar --same-owner -xf bundle.tar
    - sudo chmod -R 777 .
    - echo "keystorePassword=${ANDROID_KEYSTORE_PASSWORD/\\/\\\\}" >> keystore.properties
    - echo "keyPassword=${ANDROID_KEYSTORE_KEY_PASSWORD/\\/\\\\}" >> keystore.properties

.assemble:
  extends: .extractSecrets
  artifacts:
    paths:
      - app/build/outputs/

assembleDebug:
  interruptible: true
  extends: .assemble
  script:
    - ./gradlew --no-daemon assembleGoogleTazDebug

assembleRelease:
  interruptible: true
  extends: .assemble
  script:
    - ./gradlew --no-daemon assembleGoogleTazRelease


lint:
  interruptible: true
  extends: .extractSecrets
  stage: test
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:lint

unitTests:
  interruptible: true
  extends: .extractSecrets
  stage: test
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:test

integrationTests:
  interruptible: true
  extends: .extractSecrets
  stage: test
  cache:
    paths:
      - .gradle/wrapper
      - .gradle/caches
      - app/build
      - build
    key: android-base
    policy: pull
  before_script:
    - mkdir -p ~/.android
    - echo $ADB_PRIVKEY_BASE64 | base64 -d > ~/.android/adbkey
    - echo $ADB_PUBKEY > ~/.android/adbkey.pub
  script:
    - sudo -E ./gradlew --no-daemon -Pci --console=plain :app:cGTDAT
  tags:
    - real-android

publishNextcloud:
  stage: publish
  script:
    - curl -X MKCOL "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}/app-google-taz-debug.apk" --data-binary @"app/build/outputs/apk/googleTaz/debug/app-google-taz-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}/app-google-taz-release.apk" --data-binary @"app/build/outputs/apk/googleTaz/release/app-google-taz-release.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
  only:
    - tags

publishGooglePlay:
  stage: publish
  script:
    - ./gradlew publishGoogleTazRelease
  only:
    - tags
  when: manual
