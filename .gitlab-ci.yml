image: registry.gitlab.alt.coop/ctrlaltcoop/android-docker:latest

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - sudo chown -R circleci:circleci .

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches
  key: android-base

stages:
  - test
  - build
  - publish

lint:
  stage: test
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:lint -PbuildDir=lint
  only:
    - merge_requests

.assemble:
  stage: build
  before_script:
    - echo $SECRET_BUNDLE_BASE64 | base64 -d > bundle.tar
    - tar -xf bundle.tar
    - echo "keystorePassword=${ANDROID_KEYSTORE_PASSWORD/\\/\\\\}" >> keystore.properties
    - echo "keyPassword=${ANDROID_KEYSTORE_KEY_PASSWORD/\\/\\\\}" >> keystore.properties
  artifacts:
    paths:
      - app/build/outputs/

assembleDebug:
  extends: .assemble
  script:
    - ./gradlew --no-daemon assembleGoogleTazDebug

assembleRelease:
  extends: .assemble
  script:
    - ./gradlew --no-daemon assembleGoogleTazRelease

unitTests:
  stage: test
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:test
  only:
    - merge_requests

integrationTests:
  stage: test
  script:
    - sudo env "PATH=$PATH" ./gradlew --no-daemon -Pci --console=plain :app:cAT
  only:
    - merge_requests
  tags:
    - real-android

publishNextcloud:
  stage: publish
  script:
    - curl -X MKCOL "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}/app-google-taz-debug.apk" --data-binary @"app/build/outputs/apk/googleTaz/debug/app-google-taz-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/releases/${CI_COMMIT_TAG}/app-google-taz-release.apk" --data-binary @"app/build/outputs/apk/googleTaz/release/app-google-taz-release.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
  only:
    - tags

publishGooglePlay:
  stage: publish
  script:
    - ./gradlew publishGoogleTazRelease
  only:
    - tags
  when: manual
