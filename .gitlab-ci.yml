image: registry.gitlab.alt.coop/ctrlaltcoop/android-docker:latest

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - sudo chown -R circleci:circleci .

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches
  key: android-base

stages:
  - build
  - test

lint:
  stage: build
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:lint -PbuildDir=lint
  only:
    - merge_requests

assembleDebug:
  stage: build
  script:
    - ./gradlew --no-daemon assembleDebug
  artifacts:
    paths:
    - app/build/outputs/

unitTests:
  stage: test
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:test
  only:
    - merge_requests

integrationTests:
  stage: test
  script:
    - ${ANDROID_HOME}/emulator/emulator @test -no-boot-anim -no-window &
    - sleep 30 && ./gradlew --no-daemon -Pci --console=plain :app:cAT
  only:
    - merge_requests

