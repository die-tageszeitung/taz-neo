image: registry.gitlab.alt.coop/ctrlaltcoop/android-docker:v0.0.3

variables:
  SENTRY_ENVIRONMENT: official
  GIT_STRATEGY: fetch
  GIT_SUBMODULE_STRATEGY: recursive
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  MAVEN_LOCAL_REPOSITORY: "$CI_PROJECT_DIR/maven-local"
  GRADLE_OPTS: "-Dmaven.repo.local=$MAVEN_LOCAL_REPOSITORY -Dorg.gradle.caching=false"
  BUNDLE_VERSION: "001"

stages:
  - prepare
  - test
  - build
  - publish

.prepareEnv:
  cache:
    # This cache includes the gradle wrapper and caches.
    # It is shared between all branches and jobs that share the same gradle version.
    # Note that this cache is quite big (about 1G) and will be copied and zipped at the start and
    # end of each job. It still seems to make sense to keep it - but we should remember to clear the
    # cache from the ci interface if the pipelines get slower due to cache copying.
    - key:
        files:
          - gradle/wrapper/gradle-wrapper.properties
      paths:
        - $GRADLE_USER_HOME/wrapper
        - $GRADLE_USER_HOME/caches

    # Unfortunately gitlab does not support using files from submodules or the .git directory
    # for cache keys. Thus we have to fall back to a global cache for mupdf binaries shared across
    # all jobs. This should be fine as the cache size wont grow much as we dont update mupdf often.
    - key: mupdf-local-mvn-repo
      paths:
        - ${MAVEN_LOCAL_REPOSITORY}/com/artifex/mupdf/fitz
      policy: pull

  before_script:
    # Download and extract non-free fonts and secret configuration used by the app
    - curl -u "${BUNDLE_DIR_SHARETOKEN_AND_PASS}" "https://cloud.alt.coop/public.php/webdav/bundle-${BUNDLE_VERSION}.tar" -o bundle.tar
    - sudo tar --same-owner -xf bundle.tar
    - sudo chown -R circleci:circleci .

    # Setup the keystore from the CI secret variables
    - echo "keystorePassword=${ANDROID_KEYSTORE_PASSWORD/\\/\\\\}" >> tazkeystore.properties
    - echo "keyPassword=${ANDROID_KEYSTORE_KEY_PASSWORD/\\/\\\\}" >> tazkeystore.properties
    - echo "keystorePassword=${ANDROID_LMD_KEYSTORE_PASSWORD/\\/\\\\}" >> lmdkeystore.properties
    - echo "keyPassword=${ANDROID_LMD_KEYSTORE_KEY_PASSWORD/\\/\\\\}" >> lmdkeystore.properties

buildMupdf:
  stage: prepare
  cache:
    - key: mupdf-local-mvn-repo
      paths:
        - ${MAVEN_LOCAL_REPOSITORY}/com/artifex/mupdf/fitz
      policy: pull-push
  script:
    - if ! ./scripts/test-mupdf-in-maven-local.sh; then ./scripts/publish-mupdf-to-maven-local.sh ; fi

lint:
  stage: test
  extends: .prepareEnv
  interruptible: true
  script:
    - ./gradlew --no-daemon --console=plain lintNonfreeTazProductionDebug

unitTests:
  stage: test
  extends: .prepareEnv
  interruptible: true
  script:
    - ./gradlew --no-daemon --console=plain :app:testNonfreeTazProductionDebugUnitTest

integrationTests:
  stage: test
  extends: .prepareEnv
  interruptible: true
  script:
    - sudo -E ${ANDROID_HOME}/emulator/emulator @test -no-boot-anim -no-window &
    - sleep 30 && ./gradlew --no-daemon -Pci --console=plain :app:connectedNonfreeTazProductionDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.notAnnotation=de.taz.app.android.suite.UiTestSuite
  tags:
    - kvm-enabled

# UI Tests are disabled until we actually buy a device farm
.uiTests:
  stage: test
  extends: .prepareEnv
  variables:
    SENTRY_ENVIRONMENT: automatedTests
  script:
    - ./gradlew --no-daemon -Pci --console=plain :app:assembleNonfreeTazProductionDebug
    - ./gradlew --no-daemon -Pci --console=plain :app:assembleNonfreeTazProductionDebugAndroidTest
    - ./scripts/ui-tests-bitbar.sh app/build/outputs/apk/nonfreeTazProduction/debug/app-nonfree-taz-production-debug.apk app/build/outputs/apk/androidTest/nonfreeTazProduction/debug/app-nonfree-taz-production-debug-androidTest.apk 207052460
  only:
    - merge_requests
    - master

assembleAllTazFlavors:
  stage: build
  extends: .prepareEnv
  interruptible: true
  script:
    - ./gradlew --console=plain assembleNonfreeTazProductionDebug
                                assembleNonfreeTazProductionRelease
                                assembleNonfreeTazProductionManualUpdateRelease
    - ./gradlew --console=plain assembleFreeTazProductionDebug
                                assembleFreeTazStagingDebug
                                assembleFreeTazProductionUnminifiedRelease
  artifacts:
    paths:
      - app/build/outputs/

assembleAllLmdFlavors:
  stage: build
  extends: .prepareEnv
  interruptible: true
  script:
    - ./gradlew --console=plain assembleNonfreeLmdProductionDebug
                                assembleNonfreeLmdProductionRelease
                                assembleNonfreeLmdProductionManualUpdateRelease
    - ./gradlew --console=plain assembleFreeLmdProductionDebug
                                assembleFreeLmdProductionUnminifiedRelease
  artifacts:
    paths:
      - app/build/outputs/

publishTazNextcloud:
  stage: publish
  dependencies:
    - assembleAllTazFlavors
  variables:
    RELEASE_FOLDER: releases/${CI_COMMIT_TAG}
    NONFREE_DEBUG_APK_PATH: releases/${CI_COMMIT_TAG}/app-nonfree-taz-production-debug.apk
    NONFREE_RELEASE_APK_PATH: releases/${CI_COMMIT_TAG}/app-nonfree-taz-production-release.apk
    FREE_DEBUG_APK_PATH: releases/${CI_COMMIT_TAG}/app-free-taz-production-debug.apk
    FREE_STAGING_DEBUG_APK_PATH: releases/${CI_COMMIT_TAG}/app-free-taz-staging-debug.apk
    FREE_RELEASE_APK_PATH: releases/${CI_COMMIT_TAG}/app-free-taz-production-unminifiedRelease.apk
    NONFREE_MANUAL_UPDATE_RELEASE_APK_PATH: releases/${CI_COMMIT_TAG}/app-nonfree-taz-production-manualUpdateRelease.apk
  script:
    - curl -X MKCOL "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${RELEASE_FOLDER}" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_DEBUG_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeTazProduction/debug/app-nonfree-taz-production-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeTazProduction/release/app-nonfree-taz-production-release.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${FREE_DEBUG_APK_PATH}" --data-binary @"app/build/outputs/apk/freeTazProduction/debug/app-free-taz-production-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${FREE_STAGING_DEBUG_APK_PATH}" --data-binary @"app/build/outputs/apk/freeTazStaging/debug/app-free-taz-staging-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${FREE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/freeTazProduction/unminifiedRelease/app-free-taz-production-unminifiedRelease.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_MANUAL_UPDATE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeTazProduction/manualUpdateRelease/app-nonfree-taz-production-manualUpdateRelease.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
    - ./scripts/publish-to-app-runde.sh
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG !~ /lmd-.*/

publishTazGooglePlay:
  stage: publish
  extends: .prepareEnv
  dependencies: [] # Do not use any artifacts from the previous build stage in this job
  script:
    - ./gradlew --no-daemon --console=plain publishNonfreeTazProductionReleaseBundle
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG !~ /lmd-.*/
      when: manual


publishLmdNextcloud:
  stage: publish
  dependencies:
    - assembleAllLmdFlavors
  variables:
    RELEASE_FOLDER: releases_lmd/${CI_COMMIT_TAG}
    NONFREE_DEBUG_APK_PATH: releases_lmd/${CI_COMMIT_TAG}/app-nonfree-lmd-production-debug.apk
    NONFREE_RELEASE_APK_PATH: releases_lmd/${CI_COMMIT_TAG}/app-nonfree-lmd-production-release.apk
    FREE_DEBUG_APK_PATH: releases_lmd/${CI_COMMIT_TAG}/app-free-lmd-production-debug.apk
    FREE_RELEASE_APK_PATH: releases_lmd/${CI_COMMIT_TAG}/app-free-lmd-production-unminifiedRelease.apk
    NONFREE_MANUAL_UPDATE_RELEASE_APK_PATH: releases_lmd/${CI_COMMIT_TAG}/app-nonfree-lmd-production-manualUpdateRelease.apk
  script:
      - curl -X MKCOL "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${RELEASE_FOLDER}" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_DEBUG_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeLmdProduction/debug/app-nonfree-lmd-production-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeLmdProduction/release/app-nonfree-lmd-production-release.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${FREE_DEBUG_APK_PATH}" --data-binary @"app/build/outputs/apk/freeLmdProduction/debug/app-free-lmd-production-debug.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${FREE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/freeLmdProduction/unminifiedRelease/app-free-lmd-production-unminifiedRelease.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      - curl -X PUT "${NEXTCLOUD_RELEASE_URL}/remote.php/webdav/${NONFREE_MANUAL_UPDATE_RELEASE_APK_PATH}" --data-binary @"app/build/outputs/apk/nonfreeLmdProduction/manualUpdateRelease/app-nonfree-lmd-production-manualUpdateRelease.apk" -u ${NEXTCLOUD_RELEASE_USER}:${NEXTCLOUD_RELEASE_PASSWORD}
      # FIXME (johannes): Automatic mails are not enabled for LMd Releases yet. See https://redmine.hal.taz.de/issues/15120
      #- ./scripts/publish-to-app-runde.sh
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /lmd-.*/

publishLmdGooglePlay:
  stage: publish
  extends: .prepareEnv
  dependencies: [] # Do not use any artifacts from the previous build stage in this job
  script:
    - echo "Would do something"
    - ./gradlew --no-daemon --console=plain publishNonfreeLmdProductionReleaseBundle
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /lmd-.*/
      when: manual
